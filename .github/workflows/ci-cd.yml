name: CI/CD Pipeline

on:
  push:
    branches:
      - production # Dispara el workflow cuando se haga push a la rama 'production'
  pull_request:
    branches:
      - production
  workflow_dispatch: # Permite ejecutar el workflow manualmente desde GitHub UI

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18' # Aseg√∫rate de que esta versi√≥n sea compatible con tu proyecto React

      - name: Cache Node.js modules for 'back'
        uses: actions/cache@v4
        with:
          path: back/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('back/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
        
      - name: Install dependencies in 'back'
        working-directory: ./back
        run: npm ci

      - name: Run tests in 'back'
        working-directory: ./back
        run: npm test

      - name: Cache Node.js modules for 'gallery-images'
        uses: actions/cache@v4
        with:
          path: gallery-images/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('gallery-images/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
        
      - name: Install dependencies in 'gallery-images'
        working-directory: ./gallery-images
        run: npm ci

      - name: Run tests in 'gallery-images'
        working-directory: ./gallery-images
        run: npm test

      - name: CI Completed Successfully
        run: echo "üéâ CI Pipeline finalizado con √©xito para back y gallery-images!"

  deploy:
    runs-on: ubuntu-latest
    needs: build-and-test # Este job SOLO se ejecutar√° si el job 'build-and-test' pasa exitosamente.
    environment: production 
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up SSH Key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Build React Frontend
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Cache Node.js modules for 'front'
        uses: actions/cache@v4
        with:
          path: front/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('front/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Install dependencies for 'front'
        working-directory: ./front
        run: npm ci
      - name: Run build for 'front'
        working-directory: ./front
        run: npm run build # Este comando crear√° la carpeta 'dist' (o 'build') con los est√°ticos

      - name: Deploy Application
        run: |
          REMOTE_DIR="/home/${{ secrets.SERVER_USER }}/app-gallery" # Directorio donde se copiar√° el proyecto
          FRONT_BUILD_DIR="./front/dist" # Asumiendo que Vite crea la salida en 'dist'
          
          echo "Conectando al servidor: ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          
          # Crear el directorio remoto si no existe
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "mkdir -p $REMOTE_DIR"
          
          # Sincronizar el contenido del proyecto (excluyendo .git, node_modules, .github, y la carpeta 'front')
          echo "Copiando archivos del backend y microservicios al servidor..."
          rsync -avz --delete --exclude '.git/' --exclude 'node_modules/' --exclude '.github/' --exclude 'front/' \
            ./ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$REMOTE_DIR/

          echo "Copiando la carpeta de build de frontend al servidor..."
          # Copiar S√ìLO la carpeta de build del frontend (ej. 'dist')
          rsync -avz "$FRONT_BUILD_DIR"/ ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:$REMOTE_DIR/front_build/

          echo "Levantando servicios Docker en el servidor..."
          # Ejecutar los comandos en el servidor remoto
          # NOTA: La l√≠nea 'EOF' al final de este bloque DEBE estar indentada
          # al mismo nivel que el inicio del comando 'ssh' de esta l√≠nea.
          ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            cd "$REMOTE_DIR"
            
            # Dar permisos de ejecuci√≥n al script start-services.sh
            chmod +x ./start-services.sh
            
            # Ejecutar start-services.sh y responder 'y' para --build
            echo "y" | ./start-services.sh
            
            echo "Actualizando archivos est√°ticos del frontend..."
            rm -rf /var/www/html/app-gallery-front/* 2>/dev/null || true
            mkdir -p /var/www/html/app-gallery-front
            mv "$REMOTE_DIR"/front_build/* /var/www/html/app-gallery-front/
            
            # sudo systemctl reload nginx # Descomentar si Nginx est√° instalado directamente en el servidor host

            echo "Proceso de despliegue en el servidor completado."
          EOF # ¬°ESTA L√çNEA ES LA CLAVE! Indentada con 10 espacios (o al mismo nivel que 'ssh')

      - name: Deployment Completed
        run: echo "üöÄ Despliegue completado en el servidor remoto ${{ secrets.SERVER_HOST }}!"